---
title: "Hvo_hstA_growth"
output:
  html_document:
    df_print: paged
---

Plot raw growth curves, analyse growth rates using grofit, and plot the resultant analysis as a boxplot.
Input is growth data from 3 different bioscreen runs, each containing 3 biological replicates and 2-3 technical reps per biorep, of OD600 data of hstA KO (Hv253) and parent WT (Hv28) in optimal media (HvYPC-18%).

```{r loading,message=FALSE,warning=FALSE}
library(ggplot2)
library(forcats)
library(ggsignif)
library(grofit)
library(openxlsx)
library(readxl)
library(reshape2)

Growthtable=read_excel("TableS1-growth.xlsx")

#Information regarding strain names and run identifiers, used to separate data as needed.
Strains=c("Hv28","Hv253")
Runs=c("M11","F9","J17")
```

Converting data into a form which can be plotted - melting, removing tiny values, adding strain information.
```{r growthcurveprocessing}

Growthtablemelted=melt(Growthtable,id.vars="Time")
l1=length(Growthtablemelted$Time)

#Removing negative and very small positive values to allow plotting on log scale.
for (i in (1:l1)) {
  if (Growthtablemelted$value[i]<0.01) {
    Growthtablemelted$value[i]=0.01
  }
}

#Making a column with strain identifiers
l2=length(Strains)
strainvector=vector(length=l1)
strainvector=as.character(strainvector)
for (i in (1:l2)) {
  relrows=grep(Strains[i],Growthtablemelted$variable)
  strainvector[relrows]=Strains[i]
}

#Merging the column with  existing melted matrix

Growthtablemelted=cbind(Growthtablemelted,strainvector)
colnames(Growthtablemelted)=c("Time","variable","OD","Strain")
```

Plotting raw growth data prepared above.
```{r Curveplotting,warning=FALSE,message=FALSE}
ggplot(Growthtablemelted,aes(x=Time,y=OD,colour=Strain))+scale_colour_manual(values=c("red","cadetblue3"))+scale_fill_manual(values=c("red","cadetblue3"))+geom_smooth(se=TRUE,level=0.99,aes(col=Strain,fill=Strain))+theme(panel.background=element_rect(fill="white",colour="black"))+scale_y_log10()+geom_line(size=0.1,alpha=0.3,aes(group=variable))+ylim(c(0.01,1))
```
Preparing data as input into Grofit.
```{r grofitsetup}
#Separate OD from time data, get matrix transpose.
ODonly=Growthtable[,-1]
ODonly=t(ODonly)

l3=length(ODonly[,1])

#3 rows of metadat required - full replicate info, strain, and batch.
Grofitmetadata=as.data.frame(matrix(nrow=l3,ncol=3))
Grofitmetadata[,1]=rownames(ODonly)

#Adding strain info
for (i in (1:l2)) {
  relrows=grep(Strains[i],Grofitmetadata[,1])
  Grofitmetadata[relrows,2]=Strains[i]
}

#Adding batch info
l4=length(Runs)
for (i in (1:l4)) {
  relrows=grep(Runs[i],Grofitmetadata[,1])
  Grofitmetadata[relrows,3]=Runs[i]
}

#Putting together the matrix with metadata and OD data.
Grofitdatainput=cbind(Grofitmetadata,ODonly)


#Separate time matrix
l5=length(ODonly[1,])
Grofittimeinput=as.data.frame(matrix(nrow=l3,ncol=l5))

for (i in (1:l3)) {
  Grofittimeinput[i,]=Growthtable$Time
}
```

Measure growth rate using grofit, logistic model.
```{r Grofit}
Logisticmodelrates=gcFit(Grofittimeinput,Grofitdatainput,grofit.control(interactive=FALSE,model.type="logistic",suppress.messages=TRUE))
```

Visualise growth rate distribution for hstA v WT
```{r Boxplot,warning=FALSE,error=FALSE}
Grofitoutput=Logisticmodelrates$gcTable

#ggplot(Grofitoutput,aes(x=fct_rev(AddId),y=mu.model))+geom_boxplot(alpha=0.5,fill=c("cornflowerblue","red"))+geom_dotplot(binaxis='y',stackdir='center',dotsize = 0.6,alpha=1,aes(fill=AddId))+scale_fill_manual(values=c("red","blue"))+theme_bw()+geom_signif(data=Grofitoutput,comparisons = list(c("Hv253","Hv28")),test="t.test",map_signif_level=TRUE)+ylim(c(0,0.1))

ggplot(Grofitoutput,aes(x=fct_rev(AddId),y=mu.model,fill=AddId,color=AddId))+geom_dotplot(binaxis="y",stackdir="center",dotsize=0.75)+stat_summary(fun=median,fun.min=median,fun.max=median,geom="crossbar",width=0.5)+scale_fill_manual(values=c("lightcoral","cadetblue3"))+scale_color_manual(values=c("lightcoral","cadetblue3"))+geom_signif(data=Grofitoutput,colour="black",y_position=0.09,comparisons = list(c("Hv253","Hv28")),test="t.test",map_signif_level=TRUE)+theme_bw()+ylim(c(0,0.1))
```

```{r session}
sessionInfo()
```
